#!/bin/sh

topdomain=$1

set -eu

help () {
    echo "
    usage: $(basename $0) <topdomain>

    Init standalone installation for Puavo development.

    Setup:
        - Create certificates using the given topdomain and copies them to
          /etc/ssl/certs for slapd.
        - Set fqdn to point localhost
        - Configure LDAP client
        - Configure rng-tools
    "
    exit 2
}

[ "$topdomain" = "--help" -o "$topdomain" = "-h" ] && help
[ "$topdomain" = "" ] && help && exit 1

hostname=$(hostname)
certdir=/etc/ssl/certs
puavocerts=/etc/puavo-ca

mkdir -p /etc/puavo/kerberos

echo "Writing topdomain with kerberos to /etc/puavo"
echo $topdomain > /etc/puavo/topdomain
echo $topdomain | tr '[:lower:]' '[:upper:]' > /etc/puavo/kerberos/toprealm

echo "Adding this server to server list for puavo-ca Makefile and generate certificates"
echo $hostname > /etc/puavo-ca/servers/SERVERLIST
cd /etc/puavo-ca/
make ROOT_PASS=foobar SERVER_PASS=barfoo

echo "Certificates generated. Copying them for slapd..."
install -v -m 640 -g openldap "$puavocerts/servers/$hostname.$topdomain.key" "$certdir/slapd-server.key"
install -v -m 644 -g openldap "$puavocerts/servers/$hostname.$topdomain.crt" "$certdir/slapd-server.crt"
install -v -m 644 -g openldap "$puavocerts/servers/ca.servers.$topdomain-bundle.pem" "$certdir/slapd-ca.crt"
install -v -m 644 -g openldap "$puavocerts/rootca/ca.$topdomain.crt" "$certdir/ca.$topdomain.crt"

echo "Setting up rng-tools for puavo-ds"
# Often entropy for randomness is lacking on virtual machines which might cause
# puavo-add-new-organisation to timeout. This can be worked around with
# rng-tools
echo "HRNGDEVICE=/dev/urandom" > /etc/default/rng-tools
/etc/init.d/rng-tools restart

# Write fqdn
echo "Pointing $hostname.$topdomain to 127.0.0.1"
echo "127.0.0.1    $hostname.$topdomain" >> /etc/hosts

echo "Writing LDAP client config /etc/ldap/ldap.conf"
cat >/etc/ldap/ldap.conf <<EOF
TLS_CACERT $certdir/ca.$topdomain.crt
TLS_REQCERT demand
EOF

echo "Initializing slapd"
puavo-init-ldap

echo "Configuring puavo-ca-rails"
puavo-ca-rails-migrate
start puavo-ca-rails

echo "Standalone init ok!"

